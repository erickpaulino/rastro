-- install.sql  • Reset + criação do schema Rastro
-- Ajuste o nome do banco abaixo, se necessário
-- USE nomedobanco;

SET FOREIGN_KEY_CHECKS = 0;

DROP TABLE IF EXISTS raw_signals;
DROP TABLE IF EXISTS segments;
DROP TABLE IF EXISTS days;

SET FOREIGN_KEY_CHECKS = 1;

CREATE TABLE days (
  id           BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  date         DATE            NOT NULL,
  summary_json JSON            NULL,
  PRIMARY KEY (id),
  UNIQUE KEY uq_days_date (date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE segments (
  id           BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  day_id       BIGINT UNSIGNED NOT NULL,
  uid          VARCHAR(64)     NOT NULL,
  seq          INT UNSIGNED    NOT NULL DEFAULT 0,
  kind         ENUM('place','move') NOT NULL DEFAULT 'move',
  mode         VARCHAR(64)     NULL,
  place_name   VARCHAR(255)    NULL,
  address      VARCHAR(255)    NULL,
  start_ts     INT UNSIGNED    NULL,
  end_ts       INT UNSIGNED    NULL,
  duration_s   INT UNSIGNED    NULL,
  distance_m   INT UNSIGNED    NULL,
  lat          DECIMAL(10,7)   NULL,
  lng          DECIMAL(10,7)   NULL,
  path_json    LONGTEXT        NULL,
  raw_source   VARCHAR(32)     NULL,
  source_file  VARCHAR(255)    NULL,
  PRIMARY KEY (id),
  UNIQUE KEY uq_segments_uid (uid),
  KEY idx_segments_day_seq (day_id, seq),
  KEY idx_segments_day_ts (day_id, start_ts),
  CONSTRAINT fk_segments_day
    FOREIGN KEY (day_id) REFERENCES days (id)
    ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE raw_signals (
  id           BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  day_id       BIGINT UNSIGNED NOT NULL,
  ts           INT UNSIGNED    NOT NULL,
  kind         VARCHAR(32)     NOT NULL,
  uid          VARCHAR(64)     NOT NULL,
  lat          DECIMAL(10,7)   NULL,
  lng          DECIMAL(10,7)   NULL,
  accuracy_m   DECIMAL(10,2)   NULL,
  altitude_m   DECIMAL(10,2)   NULL,
  speed_mps    DECIMAL(10,2)   NULL,
  source       VARCHAR(100)    NULL,
  wifi_devices SMALLINT UNSIGNED NULL,
  source_file  VARCHAR(255)    NULL,
  raw_source   VARCHAR(64)     NULL,
  PRIMARY KEY (id),
  UNIQUE KEY uq_rawsignals_uid (uid),
  KEY idx_raw_day_ts (day_id, ts),
  CONSTRAINT fk_rawsignals_day
    FOREIGN KEY (day_id) REFERENCES days (id)
    ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
